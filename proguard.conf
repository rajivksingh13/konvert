# ProGuard configuration for KonvertR Spring Boot Application
# This obfuscates the JAR to protect IP while maintaining Spring Boot functionality

# Input/Output
-injars target/${project.artifactId}-${project.version}.jar
-outjars target/${project.artifactId}-${project.version}-obfuscated.jar

# Library jars (don't obfuscate dependencies)
-libraryjars <java.home>/jmods/java.base.jmod(!**.jar;!module-info.class)
-libraryjars <java.home>/jmods/java.desktop.jmod(!**.jar;!module-info.class)
-libraryjars <java.home>/jmods/java.logging.jmod(!**.jar;!module-info.class)

# Keep the main application class
-keep class com.konvert.KonvertApplication {
    public static void main(java.lang.String[]);
    public <methods>;
}

# Keep all Spring Boot annotations and annotated classes
-keep @org.springframework.stereotype.Component class *
-keep @org.springframework.stereotype.Service class *
-keep @org.springframework.stereotype.Repository class *
-keep @org.springframework.stereotype.Controller class *
-keep @org.springframework.web.bind.annotation.RestController class *
-keep @org.springframework.web.bind.annotation.Controller class *
-keep @org.springframework.boot.autoconfigure.SpringBootApplication class *
-keep @org.springframework.context.annotation.Configuration class *
-keep @org.springframework.context.annotation.Bean class *

# Keep all classes in com.konvert package (your application code)
# We'll obfuscate method/field names but keep class structure
-keep class com.konvert.** {
    *;
}

# Keep Spring Boot's internal classes
-keep class org.springframework.** { *; }
-keep class org.springframework.boot.** { *; }

# Keep Jackson annotations (for JSON/XML/YAML serialization)
-keep @com.fasterxml.jackson.annotation.JsonIgnoreProperties class *
-keep @com.fasterxml.jackson.annotation.JsonProperty class *
-keep @com.fasterxml.jackson.annotation.JsonIgnore class *
-keepclassmembers class * {
    @com.fasterxml.jackson.annotation.* <methods>;
}

# Keep all public methods in controllers (REST endpoints)
-keepclassmembers @org.springframework.web.bind.annotation.RestController class * {
    @org.springframework.web.bind.annotation.* <methods>;
    public <methods>;
}

-keepclassmembers @org.springframework.web.bind.annotation.Controller class * {
    @org.springframework.web.bind.annotation.* <methods>;
    public <methods>;
}

# Keep event listeners
-keepclassmembers class * {
    @org.springframework.context.event.EventListener <methods>;
}

# Keep application properties references
-keepclassmembers class * {
    @org.springframework.beans.factory.annotation.Value <fields>;
    @org.springframework.beans.factory.annotation.Autowired <fields>;
    @org.springframework.beans.factory.annotation.Qualifier <fields>;
}

# Keep all enum classes
-keepclassmembers enum * {
    public static **[] values();
    public static ** valueOf(java.lang.String);
}

# Keep serialization classes
-keepclassmembers class * implements java.io.Serializable {
    static final long serialVersionUID;
    private static final java.io.ObjectStreamField[] serialPersistentFields;
    private void writeObject(java.io.ObjectOutputStream);
    private void readObject(java.io.ObjectInputStream);
    java.lang.Object writeReplace();
    java.lang.Object readResolve();
}

# Keep native methods
-keepclasseswithmembernames class * {
    native <methods>;
}

# Keep classes that are referenced in application.properties or YAML
-keep class com.konvert.** { *; }

# Obfuscation settings
-optimizationpasses 5
-allowaccessmodification
-mergeinterfacesaggressively

# Note: Obfuscation is enabled by default in ProGuard when using -keep rules
# The -obfuscate option was removed in ProGuard 7.x

# Remove logging (optional - makes code smaller)
-assumenosideeffects class java.util.logging.Logger {
    public *** log(...);
    public *** fine(...);
    public *** finer(...);
    public *** finest(...);
}

# Keep line numbers for debugging (optional - remove for stronger obfuscation)
-keepattributes SourceFile,LineNumberTable
-renamesourcefileattribute SourceFile

# Print mapping (useful for debugging)
-printmapping target/proguard-mapping.txt

# Print configuration
-printconfiguration target/proguard-config.txt

# Warnings
-dontwarn org.springframework.**
-dontwarn org.slf4j.**
-dontwarn org.apache.commons.logging.**
-dontwarn javax.annotation.**
-dontwarn javax.management.**

# Don't warn about missing classes in dependencies
-dontwarn com.fasterxml.jackson.**
-dontwarn com.google.protobuf.**
-dontwarn org.yaml.snakeyaml.**
-dontwarn com.moandjiezana.toml.**

# Keep generic signatures for reflection
-keepattributes Signature
-keepattributes Exceptions
-keepattributes *Annotation*
-keepattributes EnclosingMethod
-keepattributes InnerClasses

# Repackage (optional - makes reverse engineering harder)
-repackageclasses 'obf'
-allowaccessmodification
