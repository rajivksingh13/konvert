name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build Windows installer (protects JAR files)
      run: |
        $ErrorActionPreference = "Stop"
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        Write-Host "========================================"
        Write-Host "Building Windows Installer"
        Write-Host "========================================"
        Write-Host "Version: $version"
        
        # Verify JAR exists
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found in target directory!"
          Write-Host "Contents of target directory:"
          Get-ChildItem "target\" | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        $jarName = $jarFile.Name
        Write-Host "JAR: $jarName"
        Write-Host "JAR Size: $([math]::Round($jarFile.Length / 1MB, 2)) MB"
        Write-Host ""
        
        # Create Windows installer EXE using jpackage
        # This creates a proper installer that bundles everything WITHOUT exposing JAR files
        Write-Host "Creating Windows installer with jpackage..."
        Write-Host "This may take 5-10 minutes..."
        Write-Host ""
        
        $jpackageOutput = jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type exe `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false" `
            --win-dir-chooser `
            --win-menu `
            --win-menu-group "KonvertR" `
            --win-per-user-install `
            2>&1
        
        $jpackageExitCode = $LASTEXITCODE
        
        # Always show jpackage output for debugging
        Write-Host "jpackage output:"
        Write-Host $jpackageOutput
        
        if ($jpackageExitCode -ne 0) {
          Write-Host ""
          Write-Host "ERROR: jpackage failed with exit code $jpackageExitCode"
          Write-Host "Please check the output above for error messages."
          exit 1
        }
        
        # Find the created installer EXE
        $installerExe = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if ($null -eq $installerExe -or -not (Test-Path $installerExe.FullName)) {
          Write-Host ""
          Write-Host "ERROR: Installer EXE was not created!"
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist\" -Recurse | ForEach-Object { Write-Host "  - $($_.FullName)" }
          } else {
            Write-Host "  dist directory does not exist!"
          }
          exit 1
        }
        
        Write-Host ""
        Write-Host "✓ Windows installer created successfully!"
        Write-Host "  File: $($installerExe.Name)"
        Write-Host "  Path: $($installerExe.FullName)"
        Write-Host "  Size: $([math]::Round($installerExe.Length / 1MB, 2)) MB"
        Write-Host ""
        Write-Host "Features:"
        Write-Host "  ✓ Single EXE installer file"
        Write-Host "  ✓ JAR files are NOT exposed to end users (bundled securely)"
        Write-Host "  ✓ Users can install to any directory (portable-friendly)"
        Write-Host "  ✓ Java Runtime bundled (no JRE needed)"
        Write-Host "  ✓ All dependencies included"
        Write-Host "  ✓ Professional Windows installer experience"
        Write-Host ""
        Write-Host "========================================"
    
    - name: Verify installer
      run: |
        Write-Host "Verifying installer..."
        
        $installerExe = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if ($null -eq $installerExe -or -not (Test-Path $installerExe.FullName)) {
          Write-Host "ERROR: Installer EXE not found!"
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist\" | ForEach-Object { Write-Host "  - $($_.Name)" }
          }
          exit 1
        }
        
        $exeInfo = Get-Item $installerExe.FullName
        $exeSize = $exeInfo.Length / 1MB
        
        Write-Host "  ✓ Found: $($installerExe.Name)"
        Write-Host "  ✓ Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  ✓ Type: Windows Installer EXE (jpackage --type exe)"
        Write-Host ""
        Write-Host "✓ Installer verified"
        Write-Host "  - Pure Java solution (jpackage only)"
        Write-Host "  - Single EXE installer file"
        Write-Host "  - JAR files are NOT exposed (bundled securely)"
        Write-Host "  - Users can install to any directory"
        Write-Host "  - Professional Windows installer"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        $installerExe = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if ($null -eq $installerExe -or -not (Test-Path $installerExe.FullName)) {
          Write-Host "ERROR: Installer EXE not found!"
          exit 1
        }
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        Copy-Item -Path $installerExe.FullName -Destination "$PACKAGE_NAME\$($installerExe.Name)" -Force
        Write-Host "  ✓ Copied installer: $($installerExe.Name)"
        
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Run KonvertR-$VERSION.exe to start the installer",
            "2. Choose installation directory (can be any folder, including USB drives)",
            "3. Follow the installation wizard",
            "4. Launch KonvertR from Start Menu or installation directory",
            "",
            "Everything is bundled in the installer:",
            "  - Java Runtime (JVM) - bundled inside installer",
            "  - Application code - bundled securely (JAR files NOT exposed)",
            "  - All dependencies - included",
            "",
            "IMPORTANT: JAR files and source code are NOT exposed to end users!",
            "The installer bundles everything securely. Users only see the installed application.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If the installer doesn't run:",
            "1. Try running as Administrator",
            "2. Check Windows Defender/antivirus settings",
            "3. Ensure you have write permissions to the installation directory",
            "",
            "If KonvertR doesn't start after installation:",
            "1. Check Windows Firewall settings",
            "2. Ensure port 8080 is not in use",
            "3. Try launching from Start Menu",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains only the installer EXE and README"
        Write-Host "  JAR files are NOT exposed - bundled securely in installer!"
    
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: dist/KonvertR*.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-*.exe (Windows Installer)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Windows Installer EXE - professional installation"
          Write-Host "  ✓ JAR files NOT exposed - bundled securely"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Users can install to any directory (portable-friendly)"
          Write-Host "  ✓ All dependencies included"
          Write-Host "  ✓ Simple and reliable - uses only jpackage (pure Java)"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Run KonvertR-*.exe to start installer"
          Write-Host "  2. Choose installation directory"
          Write-Host "  3. Follow installation wizard"
          Write-Host "  4. Launch from Start Menu or installation directory"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and run `KonvertR-*.exe`
          2. Choose installation directory (can be any folder)
          3. Follow the installation wizard
          4. Launch KonvertR from Start Menu or installation directory
          
          **Windows Installer** - Professional, secure, and reliable!
          
          ### What's Included
          - ✅ KonvertR-*.exe - Windows Installer (single EXE file)
          - ✅ Java Runtime bundled (inside installer)
          - ✅ All dependencies included (inside installer)
          - ✅ **JAR files are NOT exposed** - bundled securely in installer
          - ✅ **Source code is NOT exposed** - everything is packaged
          - ✅ Pure Java solution - uses only jpackage (no external tools)
          - ✅ Users can install to any directory (portable-friendly)
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
