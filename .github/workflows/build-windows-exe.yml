name: Build Windows Portable Package

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build portable package
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building portable package..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Create app-image with jpackage (pure Java solution - most reliable)
        Write-Host "Creating application package with jpackage..."
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build application package!"
          exit 1
        }
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: Executable was not created!"
          exit 1
        }
        
        Write-Host "✓ Application package created"
        
        # Create portable ZIP package (simple and reliable - no external tools needed)
        Write-Host "Creating portable ZIP package..."
        $zipPath = "dist\KonvertR-Portable-$version.zip"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        
        Compress-Archive -Path "dist\KonvertR\*" -DestinationPath $zipPath -Force
        
        if (-not (Test-Path $zipPath)) {
          Write-Host "ERROR: Failed to create ZIP package!"
          exit 1
        }
        
        $zipSize = (Get-Item $zipPath).Length / 1MB
        Write-Host "✓ Portable ZIP package created: $zipPath"
        Write-Host "  Size: $([math]::Round($zipSize, 2)) MB"
        Write-Host "  - Pure Java solution (jpackage only, no external tools)"
        Write-Host "  - Bundles JVM, JAR, and all dependencies"
        Write-Host "  - No JAR or source code visible to users"
        Write-Host "  - Users extract ZIP and run KonvertR\KonvertR.exe"
        Write-Host "  - Completely portable - no installation needed!"
    
    - name: Verify package
      run: |
        Write-Host "Verifying package..."
        
        $zipFile = Get-ChildItem "dist\KonvertR-Portable-*.zip" | Select-Object -First 1
        
        if (-not $zipFile -or -not (Test-Path $zipFile.FullName)) {
          Write-Host "ERROR: Portable ZIP package not found!"
          exit 1
        }
        
        $zipInfo = Get-Item $zipFile.FullName
        $zipSize = $zipInfo.Length / 1MB
        
        Write-Host "  ✓ Found: $($zipFile.Name)"
        Write-Host "  ✓ Size: $([math]::Round($zipSize, 2)) MB"
        Write-Host "  ✓ Type: Portable ZIP Package (pure Java, jpackage)"
        Write-Host ""
        Write-Host "✓ Package verified"
        Write-Host "  - Pure Java solution (jpackage only, no external tools)"
        Write-Host "  - ZIP contains KonvertR folder with KonvertR.exe"
        Write-Host "  - No JAR or source code exposed"
        Write-Host "  - Users extract ZIP and run KonvertR\KonvertR.exe"
        Write-Host "  - Completely portable - no installation needed"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        $zipFile = Get-ChildItem "dist\KonvertR-Portable-*.zip" | Select-Object -First 1
        
        if (-not $zipFile -or -not (Test-Path $zipFile.FullName)) {
          Write-Host "ERROR: Portable ZIP package not found!"
          exit 1
        }
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        Copy-Item -Path $zipFile.FullName -Destination "$PACKAGE_NAME\$($zipFile.Name)" -Force
        Write-Host "  ✓ Copied portable ZIP: $($zipFile.Name)"
        
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Extract the ZIP file to any location (e.g., Desktop, USB drive)",
            "2. Open the extracted KonvertR folder",
            "3. Double-click KonvertR.exe to run",
            "4. No installation required - completely portable!",
            "",
            "Everything is bundled in the KonvertR folder:",
            "  - Java Runtime (JVM) - included in the package",
            "  - Application code - included in the package",
            "  - All dependencies - included",
            "",
            "No JAR files or source code are exposed - everything is packaged!",
            "The KonvertR folder contains everything needed - just extract and run.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If KonvertR.exe doesn't run:",
            "1. Make sure you extracted the entire KonvertR folder (not just the EXE)",
            "2. Try running as Administrator",
            "3. Check Windows Firewall settings",
            "4. Ensure port 8080 is not in use",
            "5. Check Windows Defender/antivirus settings",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains only the portable EXE and README"
        Write-Host "  No JAR files or source code exposed!"
    
    - name: Upload Windows portable package
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-package
        path: dist/KonvertR-Portable-*.zip
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-Portable-*.zip (Portable ZIP package)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Portable ZIP package - no JAR or source code exposed"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Extract and run - no installation required"
          Write-Host "  ✓ All dependencies included"
          Write-Host "  ✓ Simple and reliable - uses only jpackage (pure Java)"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file to any location"
          Write-Host "  2. Open the KonvertR folder"
          Write-Host "  3. Double-click KonvertR.exe"
          Write-Host "  4. No installation needed - completely portable!"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Open the extracted `KonvertR` folder
          3. Double-click `KonvertR.exe` to run
          4. No installation required - completely portable!
          
          **Portable ZIP Package** - Simple, reliable, and easy to use!
          
          ### What's Included
          - ✅ KonvertR-Portable-*.zip - Portable ZIP package (extract and run)
          - ✅ KonvertR folder with KonvertR.exe (ready to run)
          - ✅ Java Runtime bundled (included in package)
          - ✅ All dependencies included (included in package)
          - ✅ No JAR files or source code exposed - everything is packaged!
          - ✅ Pure Java solution - uses only jpackage (no external tools)
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
