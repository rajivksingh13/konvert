name: Build Windows Portable EXE

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build single portable EXE
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building single portable EXE (self-extracting)..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Step 1: Create app-image with jpackage
        Write-Host "Step 1: Creating application package with jpackage..."
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build application package!"
          exit 1
        }
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: Executable was not created!"
          exit 1
        }
        
        Write-Host "✓ Application package created"
        
        # Step 2: Create ZIP of the app-image
        Write-Host "Step 2: Creating ZIP archive of application..."
        $zipPath = "dist\KonvertR-Temp.zip"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        Compress-Archive -Path "dist\KonvertR\*" -DestinationPath $zipPath -Force
        
        if (-not (Test-Path $zipPath)) {
          Write-Host "ERROR: Failed to create ZIP archive!"
          exit 1
        }
        
        Write-Host "✓ ZIP archive created"
        
        # Step 3: Create C# launcher and compile to EXE
        Write-Host "Step 3: Creating self-extracting EXE using C#..."
        
        # Create C# launcher program - build as array to avoid YAML parsing issues
        $csharpLines = @(
            "using System;",
            "using System.IO;",
            "using System.IO.Compression;",
            "using System.Diagnostics;",
            "using System.Reflection;",
            "using System.Threading;",
            "",
            "class KonvertRLauncher",
            "{",
            "    static void Main()",
            "    {",
            "        string tempDir = Path.Combine(Path.GetTempPath(), `"KonvertR_`" + Guid.NewGuid().ToString());",
            "        Directory.CreateDirectory(tempDir);",
            "        ",
            "        try",
            "        {",
            "            string exePath = Assembly.GetExecutingAssembly().Location;",
            "            byte[] allBytes = File.ReadAllBytes(exePath);",
            "            ",
            "            int zipStart = -1;",
            "            for (int i = allBytes.Length - 1; i >= 3; i--)",
            "            {",
            "                if (allBytes[i] == 0x50 && allBytes[i-1] == 0x4B && ",
            "                    allBytes[i-2] == 0x03 && allBytes[i-3] == 0x04)",
            "                {",
            "                    zipStart = i - 3;",
            "                    break;",
            "                }",
            "            }",
            "            ",
            "            if (zipStart == -1)",
            "            {",
            "                Console.WriteLine(`"ERROR: Could not find embedded ZIP data!`");",
            "                Console.WriteLine(`"Press any key to exit...`");",
            "                Console.ReadKey();",
            "                return;",
            "            }",
            "            ",
            "            byte[] zipBytes = new byte[allBytes.Length - zipStart];",
            "            Array.Copy(allBytes, zipStart, zipBytes, 0, zipBytes.Length);",
            "            string zipPath = Path.Combine(tempDir, `"app.zip`");",
            "            File.WriteAllBytes(zipPath, zipBytes);",
            "            ",
            "            ZipFile.ExtractToDirectory(zipPath, tempDir);",
            "            ",
            "            string konvertExePath = Path.Combine(tempDir, `"KonvertR`", `"KonvertR.exe`");",
            "            if (File.Exists(konvertExePath))",
            "            {",
            "                Process process = Process.Start(new ProcessStartInfo",
            "                {",
            "                    FileName = konvertExePath,",
            "                    UseShellExecute = true",
            "                });",
            "                process.WaitForExit();",
            "            }",
            "            else",
            "            {",
            "                Console.WriteLine(`"ERROR: KonvertR.exe not found!`");",
            "                Console.WriteLine(`"Expected path: `" + konvertExePath);",
            "                Console.WriteLine(`"Press any key to exit...`");",
            "                Console.ReadKey();",
            "            }",
            "        }",
            "        catch (Exception ex)",
            "        {",
            "            Console.WriteLine(`"ERROR: `" + ex.Message);",
            "            Console.WriteLine(ex.StackTrace);",
            "            Console.WriteLine(`"Press any key to exit...`");",
            "            Console.ReadKey();",
            "        }",
            "        finally",
            "        {",
            "            Thread.Sleep(2000);",
            "            try",
            "            {",
            "                if (Directory.Exists(tempDir))",
            "                {",
            "                    Directory.Delete(tempDir, true);",
            "                }",
            "            }",
            "            catch { }",
            "        }",
            "    }",
            "}"
        )
        $csharpCode = $csharpLines -join "`n"
        
        # Create temp directory for C# project
        $csProjectDir = "dist\LauncherProject"
        New-Item -ItemType Directory -Path $csProjectDir -Force | Out-Null
        
        # Save C# code
        $csFilePath = Join-Path $csProjectDir "Program.cs"
        $csharpCode | Out-File -FilePath $csFilePath -Encoding UTF8
        
        # Create .csproj file - build as array to avoid YAML parsing issues
        $csprojLines = @(
            "<Project Sdk=`"Microsoft.NET.Sdk`">",
            "  <PropertyGroup>",
            "    <OutputType>Exe</OutputType>",
            "    <TargetFramework>net6.0</TargetFramework>",
            "    <Nullable>enable</Nullable>",
            "    <AssemblyName>KonvertR-Portable-$version</AssemblyName>",
            "    <RootNamespace>KonvertRLauncher</RootNamespace>",
            "  </PropertyGroup>",
            "</Project>"
        )
        $csprojContent = $csprojLines -join "`n"
        $csprojPath = Join-Path $csProjectDir "Launcher.csproj"
        $csprojContent | Out-File -FilePath $csprojPath -Encoding UTF8
        
        # Compile C# program to EXE
        Write-Host "Compiling C# launcher..."
        dotnet build "$csProjectDir\Launcher.csproj" -c Release -o "$csProjectDir\bin" 2>&1 | Out-Null
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to compile C# launcher!"
          exit 1
        }
        
        # Get compiled EXE
        $compiledExe = Get-ChildItem "$csProjectDir\bin\Release\net6.0\*.exe" | Select-Object -First 1
        
        if (-not $compiledExe) {
          Write-Host "ERROR: Compiled EXE not found!"
          exit 1
        }
        
        # Read compiled EXE and ZIP bytes
        $exeBytes = [System.IO.File]::ReadAllBytes($compiledExe.FullName)
        $zipBytes = [System.IO.File]::ReadAllBytes($zipPath)
        
        # Combine: EXE + ZIP data
        $finalCombinedBytes = New-Object byte[] ($exeBytes.Length + $zipBytes.Length)
        [System.Array]::Copy($exeBytes, 0, $finalCombinedBytes, 0, $exeBytes.Length)
        [System.Array]::Copy($zipBytes, 0, $finalCombinedBytes, $exeBytes.Length, $zipBytes.Length)
        
        # Save final EXE
        $finalExePath = "dist\KonvertR-Portable-$version.exe"
        [System.IO.File]::WriteAllBytes($finalExePath, $finalCombinedBytes)
        
        # Cleanup
        Remove-Item $csProjectDir -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item $zipPath -Force -ErrorAction SilentlyContinue
        
        # Verify the EXE was created
        if (-not (Test-Path $finalExePath)) {
          Write-Host "ERROR: Self-extracting EXE was not created!"
          exit 1
        }
        
        $exeSize = (Get-Item $finalExePath).Length / 1MB
        Write-Host "✓ Single self-extracting EXE created: $finalExePath"
        Write-Host "  Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  - Extracts to temp folder when run"
        Write-Host "  - Launches KonvertR automatically"
        Write-Host "  - Cleans up on exit"
        Write-Host "  - No JAR or source code visible to users"
        Write-Host "  - Users just double-click to run (no installation needed!)"
    
    - name: Verify executable
      run: |
        Write-Host "Verifying executable..."
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Portable EXE not found!"
          exit 1
        }
        
        $exeInfo = Get-Item $exeFile.FullName
        $exeSize = $exeInfo.Length / 1MB
        
        Write-Host "  ✓ Found: $($exeFile.Name)"
        Write-Host "  ✓ Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  ✓ Type: Self-extracting Portable EXE (single file)"
        Write-Host ""
        Write-Host "✓ Executable verified"
        Write-Host "  - Single EXE file contains everything"
        Write-Host "  - No JAR or source code exposed"
        Write-Host "  - Extracts to temp folder when run"
        Write-Host "  - Launches automatically, no installation needed"
        Write-Host "  - Users just double-click to run"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Portable EXE not found!"
          exit 1
        }
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        Copy-Item -Path $exeFile.FullName -Destination "$PACKAGE_NAME\$($exeFile.Name)" -Force
        Write-Host "  ✓ Copied portable EXE: $($exeFile.Name)"
        
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Double-click KonvertR-Portable-$VERSION.exe to run",
            "2. The application will extract to a temp folder and launch automatically",
            "3. No installation required - just double-click and run!",
            "",
            "Everything is bundled in this single EXE file:",
            "  - Java Runtime (JVM) - bundled inside",
            "  - Application code - bundled inside",
            "  - All dependencies - included",
            "",
            "No JAR files or source code are exposed - everything is packaged!",
            "The application extracts to a temp folder when run and cleans up on exit.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If the EXE doesn't run:",
            "1. Try running as Administrator",
            "2. Check Windows Firewall settings",
            "3. Ensure port 8080 is not in use",
            "4. Check Windows Defender/antivirus settings (may block self-extracting EXE)",
            "5. Make sure you have write permissions to temp folder",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains only the portable EXE and README"
        Write-Host "  No JAR files or source code exposed!"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/KonvertR*.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-Portable-*.exe (Self-extracting portable EXE - single file)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Single EXE file - no JAR or source code exposed"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Double-click to run - no installation required"
          Write-Host "  ✓ Extracts to temp folder automatically"
          Write-Host "  ✓ Cleans up on exit"
          Write-Host "  ✓ All dependencies included"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR-Portable-*.exe"
          Write-Host "  3. Application extracts and launches automatically"
          Write-Host "  4. No installation needed - completely portable!"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR-Portable-*.exe` to run
          3. The application will extract to a temp folder and launch automatically
          4. No installation required - completely portable!
          
          **Self-extracting Portable EXE** - Everything bundled in one file!
          
          ### What's Included
          - ✅ KonvertR-Portable-*.exe - Self-extracting portable EXE (single file, double-click to run)
          - ✅ Java Runtime bundled (inside EXE)
          - ✅ All dependencies included (inside EXE)
          - ✅ No JAR files or source code exposed - everything is packaged!
          - ✅ Extracts to temp folder when run, cleans up on exit
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
