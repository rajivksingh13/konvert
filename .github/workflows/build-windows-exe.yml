name: Build Windows EXE Distribution

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build-windows-exe:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Install WiX Toolset
      run: |
        Write-Host "Installing WiX Toolset..."
        
        # Try Chocolatey first
        choco install wixtoolset -y 2>&1 | Out-Null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "WiX installed via Chocolatey"
        } else {
          Write-Host "Chocolatey install failed, downloading WiX directly..."
          $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip"
          $wixZip = "$env:TEMP\wix.zip"
          $wixDir = "$env:TEMP\wix"
          
          Invoke-WebRequest -Uri $wixUrl -OutFile $wixZip -UseBasicParsing
          Expand-Archive -Path $wixZip -DestinationPath $wixDir -Force
          $env:PATH += ";$wixDir"
          Write-Host "WiX downloaded and extracted"
        }
        
        # Find WiX installation
        $wixPaths = @(
          "C:\Program Files (x86)\WiX Toolset v3.11\bin",
          "C:\Program Files (x86)\WiX Toolset v3.14\bin",
          "$env:TEMP\wix"
        )
        
        $wixFound = $false
        foreach ($path in $wixPaths) {
          if (Test-Path "$path\candle.exe") {
            $env:PATH = "$path;$env:PATH"
            Write-Host "WiX found at: $path"
            $wixFound = $true
            break
          }
        }
        
        if (-not $wixFound) {
          Write-Host "ERROR: WiX Toolset not found!"
          exit 1
        }
        
        # Verify WiX works
        candle -? 2>&1 | Out-Null
        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 1) {
          Write-Host "ERROR: WiX Toolset verification failed!"
          exit 1
        }
        Write-Host "WiX Toolset verified and ready"
    
    - name: Create Windows EXE installer
      run: |
        # Ensure WiX is in PATH
        $wixPaths = @(
          "C:\Program Files (x86)\WiX Toolset v3.11\bin",
          "C:\Program Files (x86)\WiX Toolset v3.14\bin",
          "$env:TEMP\wix"
        )
        
        foreach ($path in $wixPaths) {
          if (Test-Path "$path\candle.exe") {
            $env:PATH = "$path;$env:PATH"
            break
          }
        }
        
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Creating Windows EXE installer..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        Write-Host "WiX PATH: $env:PATH"
        
        # Verify WiX is accessible
        $candleCheck = Get-Command candle -ErrorAction SilentlyContinue
        if ($candleCheck) {
          Write-Host "WiX candle found at: $($candleCheck.Source)"
        } else {
          Write-Host "WARNING: WiX candle not found in PATH, jpackage may fail"
        }
        
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --type exe `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --win-dir-chooser `
            --win-menu `
            --win-shortcut `
            --win-menu-group "KonvertR" `
            --win-per-user-install `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: jpackage failed with EXE type!"
          Write-Host "This might be due to WiX Toolset not being found."
          Write-Host "Trying app-image type instead (no WiX needed)..."
          
          # Fallback to app-image if exe fails
          jpackage --input target `
              --name KonvertR `
              --main-jar $jarName `
              --type app-image `
              --app-version $version `
              --description "KonvertR - Universal Format Converter" `
              --vendor "KonvertR" `
              --copyright "Copyright 2024 KonvertR" `
              --dest dist `
              --java-options "-Xmx512m" `
              --java-options "-Dserver.port=8080"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: jpackage failed with app-image as well!"
            exit 1
          }
          
          Write-Host "Created app-image instead of installer EXE"
          "app-image" | Out-File -FilePath "$env:GITHUB_WORKSPACE\build-type.txt"
        } else {
          "exe" | Out-File -FilePath "$env:GITHUB_WORKSPACE\build-type.txt"
        }
    
    - name: Verify executable created
      run: |
        $buildType = Get-Content "$env:GITHUB_WORKSPACE\build-type.txt" -ErrorAction SilentlyContinue
        if (-not $buildType) { $buildType = "exe" }
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        $appImage = Test-Path "dist\KonvertR"
        
        if ($buildType -eq "exe" -and $exeFile) {
          Write-Host "EXE installer created: $($exeFile.Name)"
          Write-Host "Size: $([math]::Round($exeFile.Length/1MB, 2)) MB"
        } elseif ($buildType -eq "app-image" -and $appImage) {
          Write-Host "App-image created (fallback - WiX not available)"
          Write-Host "Location: dist\KonvertR"
        } else {
          Write-Host "ERROR: No executable file found!"
          exit 1
        }
    
    - name: Create distribution package
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $buildType = Get-Content "$env:GITHUB_WORKSPACE\build-type.txt" -ErrorAction SilentlyContinue
        if (-not $buildType) { $buildType = "exe" }
        
        $distDir = "dist\KonvertR-Windows-$version"
        New-Item -ItemType Directory -Path $distDir -Force | Out-Null
        
        if ($buildType -eq "exe") {
          # EXE installer was created
          $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
          Copy-Item $exeFile.FullName -Destination "$distDir\KonvertR-Setup-$version.exe"
          Write-Host "Packaged EXE installer"
        } else {
          # App-image was created (fallback)
          $appImageDir = "dist\KonvertR"
          if (Test-Path $appImageDir) {
            # Copy the entire app-image folder
            Copy-Item -Path "$appImageDir\*" -Destination $distDir -Recurse -Force
            Write-Host "Packaged app-image (portable application)"
            Write-Host "NOTE: This is a portable folder, not a single EXE installer"
            Write-Host "Users run: KonvertR\KonvertR.exe"
          } else {
            Write-Host "ERROR: No executable found!"
            exit 1
          }
        }
        
        # Create README based on build type
        $buildType = Get-Content "$env:GITHUB_WORKSPACE\build-type.txt" -ErrorAction SilentlyContinue
        if (-not $buildType) { $buildType = "exe" }
        
        if ($buildType -eq "exe") {
          $readmeLines = @(
              "# KonvertR - Universal Format Converter",
              "",
              "## Installation",
              "",
              "1. Run KonvertR-Setup-$version.exe",
              "2. Follow the installation wizard",
              "3. Launch from Start Menu or Desktop shortcut",
              "",
              "## System Requirements",
              "",
              "- Windows 10 or later",
              "- 200 MB free disk space",
              "",
              "## Features",
              "",
              "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
              "- Format and beautify data",
              "- Encode/Decode utilities",
              "- File upload and processing",
              "- All features work offline",
              "",
              "Version: $version"
          )
        } else {
          $readmeLines = @(
              "# KonvertR - Universal Format Converter",
              "",
              "## Installation",
              "",
              "1. Extract this ZIP file to your desired location",
              "2. Navigate to the KonvertR folder",
              "3. Double-click KonvertR.exe to run",
              "",
              "## System Requirements",
              "",
              "- Windows 10 or later",
              "- 200 MB free disk space",
              "",
              "## Features",
              "",
              "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
              "- Format and beautify data",
              "- Encode/Decode utilities",
              "- File upload and processing",
              "- All features work offline",
              "",
              "Version: $version"
          )
        }
        $readmeLines | Out-File -FilePath "$distDir\README.txt" -Encoding UTF8
    
    - name: Create ZIP distribution
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $zipName = "KonvertR-Windows-$version.zip"
        Compress-Archive -Path "dist\KonvertR-Windows-$version\*" -DestinationPath "dist\$zipName" -Force
        Write-Host "Created: dist\$zipName"
        Get-Item "dist\$zipName" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}
    
    - name: Upload Windows EXE distribution
      uses: actions/upload-artifact@v4
      with:
        name: KonvertR-Windows-EXE
        path: dist/KonvertR-Windows-*.zip
        retention-days: 30
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/KonvertR-Windows-*.zip
        body: |
          ## KonvertR Windows EXE Distribution
          
          ### Installation
          1. Download and extract the ZIP file
          2. Run `KonvertR-Setup-{version}.exe`
          3. Follow the installation wizard
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          
          **Note:** This is a Windows installer. The application will be installed to Program Files.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
