name: Build Windows Executables

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build portable executable
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building portable executable..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Create app-image (portable application, no installer needed)
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build executable!"
          exit 1
        }
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: Executable was not created!"
          exit 1
        }
        
        Write-Host "✓ Portable executable created: dist\KonvertR\KonvertR.exe"
    
    - name: Verify executable
      run: |
        Write-Host "Verifying executable..."
        if (Test-Path "dist\KonvertR\KonvertR.exe") {
          $exeInfo = Get-Item "dist\KonvertR\KonvertR.exe"
          Write-Host "  Found: KonvertR.exe ($([math]::Round($exeInfo.Length / 1MB, 2)) MB)"
        } else {
          Write-Host "ERROR: Executable not found!"
          exit 1
        }
        Write-Host "✓ Executable verified"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          # Remove 'v' prefix if present
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        # Create package directory
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        # Copy the entire KonvertR app-image folder
        if (Test-Path "dist\KonvertR") {
          Copy-Item -Path "dist\KonvertR\*" -Destination "$PACKAGE_NAME\" -Recurse -Force
          Write-Host "  ✓ Copied executable and dependencies"
        } else {
          Write-Host "ERROR: KonvertR app-image not found!"
          exit 1
        }
        
        # Copy documentation files
        $filesToCopy = @(
          @{src="README.md"; required=$false},
          @{src="QUICKSTART.md"; required=$false},
          @{src="LICENSE"; required=$false}
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file.src) {
            Copy-Item $file.src "$PACKAGE_NAME\" -ErrorAction SilentlyContinue
            if ($LASTEXITCODE -eq 0) {
              Write-Host "  ✓ Copied $($file.src)"
            }
          } elseif ($file.required) {
            Write-Host "  WARNING: $($file.src) not found (optional)"
          }
        }
        
        # Create README.txt for users
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Extract this ZIP file to any location",
            "2. Double-click KonvertR.exe to run",
            "3. The application will open in your default web browser",
            "",
            "No installation required! Just extract and run.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If the application doesn't start:",
            "1. Make sure you extracted all files from the ZIP",
            "2. Try running KonvertR.exe as Administrator",
            "3. Check Windows Firewall settings",
            "4. Ensure port 8080 is not in use by another application",
            "",
            "For more information, see README.md in this folder.",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        # Create ZIP archive
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
    
    - name: Upload Windows executables
      uses: actions/upload-artifact@v4
      with:
        name: windows-executables
        path: |
          dist/KonvertR/KonvertR.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR.exe (main executable)"
          Write-Host "  - Java Runtime (bundled)"
          Write-Host "  - All dependencies"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR.exe"
          Write-Host "  3. Application opens in browser"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR.exe` to run
          3. The application will open in your default web browser
          
          **No installation required!** Just extract and run.
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
