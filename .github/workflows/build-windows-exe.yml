name: Build Windows Portable EXE

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Install 7-Zip (for self-extracting EXE)
      run: |
        # Check if 7-Zip is already installed
        $7zipPath = "${env:ProgramFiles}\7-Zip\7z.exe"
        if (-not (Test-Path $7zipPath)) {
          $7zipPath = "${env:ProgramFiles(x86)}\7-Zip\7z.exe"
        }
        
        if (-not (Test-Path $7zipPath)) {
          Write-Host "7-Zip not found. Installing via Chocolatey..."
          choco install 7zip -y --no-progress
          
          # Refresh PATH
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Verify installation
          $7zipPath = "${env:ProgramFiles}\7-Zip\7z.exe"
          if (Test-Path $7zipPath) {
            Write-Host "✓ 7-Zip installed successfully"
          } else {
            Write-Host "ERROR: Failed to install 7-Zip!"
            exit 1
          }
        } else {
          Write-Host "✓ 7-Zip already installed"
        }
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build single portable EXE
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building single portable EXE (self-extracting)..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Step 1: Create app-image with jpackage (pure Java solution)
        Write-Host "Step 1: Creating application package with jpackage..."
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build application package!"
          exit 1
        }
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: Executable was not created!"
          exit 1
        }
        
        Write-Host "✓ Application package created"
        
        # Step 2: Create self-extracting EXE using 7-Zip (pure Java + 7-Zip, no .NET)
        Write-Host "Step 2: Creating self-extracting EXE using 7-Zip..."
        
        # Find 7-Zip (should be installed in previous step)
        $7zipPath = "${env:ProgramFiles}\7-Zip\7z.exe"
        if (-not (Test-Path $7zipPath)) {
          $7zipPath = "${env:ProgramFiles(x86)}\7-Zip\7z.exe"
        }
        
        if (-not (Test-Path $7zipPath)) {
          Write-Host "ERROR: 7-Zip not found! It should have been installed in a previous step."
          Write-Host "Falling back to portable ZIP package..."
          # Fallback: Create ZIP package
          $zipPath = "dist\KonvertR-Portable-$version.zip"
          Compress-Archive -Path "dist\KonvertR\*" -DestinationPath $zipPath -Force
          Write-Host "✓ Portable ZIP package created: $zipPath"
          Write-Host "  Users can extract and run KonvertR\KonvertR.exe"
          exit 0
        }
        
        Write-Host "Using 7-Zip at: $7zipPath"
        
        # Create 7z archive
        $archivePath = "dist\KonvertR-Temp.7z"
        if (Test-Path $archivePath) { Remove-Item $archivePath -Force }
        
        & $7zipPath a -t7z -mx=9 "$archivePath" "dist\KonvertR\*" | Out-Null
        
        if (-not (Test-Path $archivePath)) {
          Write-Host "ERROR: Failed to create 7z archive!"
          exit 1
        }
        
        Write-Host "✓ 7z archive created"
        
        # Create SFX config for 7-Zip
        $sfxConfigLines = @(
            ";!@Install@!UTF-8!",
            "Title=`"KonvertR - Universal Format Converter`"",
            "BeginPrompt=`"Extracting KonvertR...`"",
            "ExecuteFile=`"KonvertR\\KonvertR.exe`"",
            "ExecuteParameters=`"`"",
            "GUIMode=`"1`"",
            "ExtractPathText=`"Extracting to temporary folder...`"",
            "ExtractTitle=`"Extracting`"",
            "FinishMessage=`"Launching KonvertR...`"",
            ";!@InstallEnd@!"
        )
        $sfxConfig = $sfxConfigLines -join "`n"
        $sfxConfigPath = "dist\sfx_config.txt"
        $sfxConfig | Out-File -FilePath $sfxConfigPath -Encoding ASCII -NoNewline
        
        # Get 7-Zip SFX module
        $sfxModulePath = "${env:ProgramFiles}\7-Zip\7z.sfx"
        if (-not (Test-Path $sfxModulePath)) {
          $sfxModulePath = "${env:ProgramFiles(x86)}\7-Zip\7z.sfx"
        }
        
        if (-not (Test-Path $sfxModulePath)) {
          Write-Host "ERROR: 7-Zip SFX module not found!"
          exit 1
        }
        
        # Combine: SFX module + config + archive = self-extracting EXE
        $finalExePath = "dist\KonvertR-Portable-$version.exe"
        if (Test-Path $finalExePath) { Remove-Item $finalExePath -Force }
        
        $sfxBytes = [System.IO.File]::ReadAllBytes($sfxModulePath)
        $configBytes = [System.IO.File]::ReadAllBytes($sfxConfigPath)
        $archiveBytes = [System.IO.File]::ReadAllBytes($archivePath)
        
        $combinedBytes = New-Object byte[] ($sfxBytes.Length + $configBytes.Length + $archiveBytes.Length)
        [System.Array]::Copy($sfxBytes, 0, $combinedBytes, 0, $sfxBytes.Length)
        [System.Array]::Copy($configBytes, 0, $combinedBytes, $sfxBytes.Length, $configBytes.Length)
        [System.Array]::Copy($archiveBytes, 0, $combinedBytes, $sfxBytes.Length + $configBytes.Length, $archiveBytes.Length)
        
        [System.IO.File]::WriteAllBytes($finalExePath, $combinedBytes)
        
        # Cleanup
        Remove-Item $archivePath -Force -ErrorAction SilentlyContinue
        Remove-Item $sfxConfigPath -Force -ErrorAction SilentlyContinue
        
        Write-Host "✓ Self-extracting EXE created (pure Java + 7-Zip, no .NET required)"
        
        # Verify the EXE was created
        if (-not (Test-Path $finalExePath)) {
          Write-Host "ERROR: Self-extracting EXE was not created!"
          exit 1
        }
        
        $exeSize = (Get-Item $finalExePath).Length / 1MB
        Write-Host "✓ Self-extracting EXE created: $finalExePath"
        Write-Host "  Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  - Pure Java solution (jpackage + 7-Zip, no .NET required)"
        Write-Host "  - Bundles JVM, JAR, and all dependencies"
        Write-Host "  - Extracts to temp folder when run"
        Write-Host "  - Launches KonvertR automatically"
        Write-Host "  - No JAR or source code visible to users"
        Write-Host "  - Users just double-click to run (no installation needed!)"
    
    - name: Verify executable
      run: |
        Write-Host "Verifying executable..."
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Portable EXE not found!"
          exit 1
        }
        
        $exeInfo = Get-Item $exeFile.FullName
        $exeSize = $exeInfo.Length / 1MB
        
        Write-Host "  ✓ Found: $($exeFile.Name)"
        Write-Host "  ✓ Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  ✓ Type: Self-extracting EXE (pure Java + 7-Zip)"
        Write-Host ""
        Write-Host "✓ Executable verified"
        Write-Host "  - Pure Java solution (jpackage + 7-Zip, no .NET required)"
        Write-Host "  - Single EXE file contains everything"
        Write-Host "  - No JAR or source code exposed"
        Write-Host "  - Extracts to temp folder when run"
        Write-Host "  - Launches automatically, no installation needed"
        Write-Host "  - Users just double-click to run"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Portable EXE not found!"
          exit 1
        }
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        Copy-Item -Path $exeFile.FullName -Destination "$PACKAGE_NAME\$($exeFile.Name)" -Force
        Write-Host "  ✓ Copied portable EXE: $($exeFile.Name)"
        
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Double-click KonvertR-Portable-$VERSION.exe to run",
            "2. The application will extract to a temp folder and launch automatically",
            "3. No installation required - just double-click and run!",
            "4. The temp folder is cleaned up automatically when you exit",
            "",
            "Everything is bundled in this single EXE file:",
            "  - Java Runtime (JVM) - bundled inside",
            "  - Application code - bundled inside",
            "  - All dependencies - included",
            "",
            "No JAR files or source code are exposed - everything is packaged!",
            "The application extracts to a temp folder when run and cleans up on exit.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If the EXE doesn't run:",
            "1. Try running as Administrator",
            "2. Check Windows Firewall settings",
            "3. Ensure port 8080 is not in use",
            "4. Check Windows Defender/antivirus settings (may block self-extracting EXE)",
            "5. Make sure you have write permissions to temp folder",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains only the portable EXE and README"
        Write-Host "  No JAR files or source code exposed!"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/KonvertR*.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-Portable-*.exe (Self-extracting portable EXE - single file)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Single EXE file - no JAR or source code exposed"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Double-click to run - no installation required"
          Write-Host "  ✓ Extracts to temp folder automatically"
          Write-Host "  ✓ Cleans up on exit"
          Write-Host "  ✓ All dependencies included"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR-Portable-*.exe"
          Write-Host "  3. Application extracts and launches automatically"
          Write-Host "  4. No installation needed - completely portable!"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR-Portable-*.exe` to run
          3. The application will extract to a temp folder and launch automatically
          4. No installation required - completely portable!
          
          **Self-extracting Portable EXE** - Everything bundled in one file!
          
          ### What's Included
          - ✅ KonvertR-Portable-*.exe - Self-extracting portable EXE (single file, double-click to run)
          - ✅ Java Runtime bundled (inside EXE)
          - ✅ All dependencies included (inside EXE)
          - ✅ No JAR files or source code exposed - everything is packaged!
          - ✅ Extracts to temp folder when run, cleans up on exit
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
