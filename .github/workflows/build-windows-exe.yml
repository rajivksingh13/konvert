name: Build Windows Executables

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build single portable EXE
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building single portable EXE..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Use jpackage to create a Windows installer EXE (single file)
        # This creates a proper Windows installer that bundles everything
        # Users can choose installation directory, making it portable
        Write-Host "Creating Windows installer EXE with jpackage..."
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type exe `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false" `
            --win-dir-chooser `
            --win-menu `
            --win-shortcut
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build Windows installer EXE!"
          exit 1
        }
        
        # Find the created EXE file
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Windows installer EXE was not created!"
          exit 1
        }
        
        # Rename to include version
        $finalExePath = "dist\KonvertR-Portable-$version.exe"
        if ($exeFile.Name -ne "KonvertR-Portable-$version.exe") {
          Move-Item -Path $exeFile.FullName -Destination $finalExePath -Force
        }
        
        $exeSize = (Get-Item $finalExePath).Length / 1MB
        Write-Host "✓ Single Windows installer EXE created: $finalExePath"
        Write-Host "  Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  - Single EXE file - no JAR or source code exposed"
        Write-Host "  - Users double-click to install and run"
        Write-Host "  - Can choose installation directory (portable)"
        Write-Host "  - Everything bundled (JVM, JAR, dependencies)"
    
    - name: Verify executable
      run: |
        Write-Host "Verifying executable..."
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Windows installer EXE not found!"
          exit 1
        }
        
        $exeInfo = Get-Item $exeFile.FullName
        $exeSize = $exeInfo.Length / 1MB
        
        Write-Host "  ✓ Found: $($exeFile.Name)"
        Write-Host "  ✓ Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  ✓ Type: Windows Installer EXE (single file)"
        Write-Host ""
        Write-Host "✓ Executable verified"
        Write-Host "  - Single EXE file contains everything"
        Write-Host "  - No JAR or source code exposed"
        Write-Host "  - Users double-click to install and run"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          # Remove 'v' prefix if present
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        # Find the installer EXE
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        
        if (-not $exeFile -or -not (Test-Path $exeFile.FullName)) {
          Write-Host "ERROR: Windows installer EXE not found!"
          exit 1
        }
        
        # Create package directory
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        # Copy only the single EXE file (this is the installer that contains everything)
        Copy-Item -Path $exeFile.FullName -Destination "$PACKAGE_NAME\$($exeFile.Name)" -Force
        Write-Host "  ✓ Copied installer EXE: $($exeFile.Name)"
        
        # Create README.txt for users
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Double-click KonvertR-Portable-$VERSION.exe to install",
            "2. Choose installation directory (can be any location for portability)",
            "3. The application will be installed and launched automatically",
            "4. A shortcut will be created in the Start Menu",
            "",
            "Everything is bundled in this single EXE file:",
            "  - Java Runtime (JVM) - bundled inside",
            "  - Application code - bundled inside",
            "  - All dependencies - included",
            "",
            "No JAR files or source code are exposed - everything is packaged!",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If the installer doesn't run:",
            "1. Try running as Administrator",
            "2. Check Windows Firewall settings",
            "3. Ensure port 8080 is not in use",
            "4. Check Windows Defender/antivirus settings",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        # Create ZIP archive containing only the EXE and README
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains only the installer EXE and README"
        Write-Host "  No JAR files or source code exposed!"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/KonvertR*.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-Portable-*.exe (Windows installer - single file)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Single EXE file - no JAR or source code exposed"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Double-click to install and run"
          Write-Host "  ✓ Can choose installation directory (portable)"
          Write-Host "  ✓ All dependencies included"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR-Portable-*.exe"
          Write-Host "  3. Choose installation directory"
          Write-Host "  4. Application installs and launches automatically"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR-Portable-*.exe` to install
          3. Choose installation directory (can be any location for portability)
          4. The application will install and launch automatically
          
          **Single EXE installer** - Everything bundled in one file!
          
          ### What's Included
          - ✅ KonvertR-Portable-*.exe - Windows installer (single file, double-click to install)
          - ✅ Java Runtime bundled (inside installer)
          - ✅ All dependencies included (inside installer)
          - ✅ No JAR files or source code exposed - everything is packaged!
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
