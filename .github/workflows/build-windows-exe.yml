name: Build Windows Executables

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Install WiX Toolset
      run: |
        Write-Host "Installing WiX Toolset for jpackage..."
        
        # Check if WiX is already installed
        $wixPaths = @(
          "C:\Program Files (x86)\WiX Toolset v3.11\bin",
          "C:\Program Files (x86)\WiX Toolset v3.14\bin"
        )
        
        $wixFound = $false
        foreach ($path in $wixPaths) {
          if (Test-Path "$path\candle.exe") {
            $env:PATH = "$path;$env:PATH"
            Write-Host "WiX found at: $path"
            $wixFound = $true
            break
          }
        }
        
        if (-not $wixFound) {
          Write-Host "WiX not found, installing via Chocolatey..."
          choco install wixtoolset -y --no-progress
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Chocolatey install failed, downloading WiX directly..."
            $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip"
            $wixZip = "$env:TEMP\wix.zip"
            $wixDir = "$env:TEMP\wix"
            
            Invoke-WebRequest -Uri $wixUrl -OutFile $wixZip -UseBasicParsing
            Expand-Archive -Path $wixZip -DestinationPath $wixDir -Force
            $env:PATH += ";$wixDir"
            Write-Host "WiX downloaded and extracted"
          } else {
            # Refresh PATH to include WiX
            $env:PATH = "C:\Program Files (x86)\WiX Toolset v3.11\bin;$env:PATH"
          }
        }
        
        # Verify WiX works
        $candleCheck = Get-Command candle -ErrorAction SilentlyContinue
        if ($candleCheck) {
          Write-Host "✓ WiX Toolset verified: $($candleCheck.Source)"
        } else {
          Write-Host "WARNING: WiX verification failed, but continuing..."
        }
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build single EXE installer
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building single EXE installer..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Ensure WiX is in PATH
        $wixPaths = @(
          "C:\Program Files (x86)\WiX Toolset v3.11\bin",
          "C:\Program Files (x86)\WiX Toolset v3.14\bin",
          "$env:TEMP\wix"
        )
        
        foreach ($path in $wixPaths) {
          if (Test-Path "$path\candle.exe") {
            $env:PATH = "$path;$env:PATH"
            break
          }
        }
        
        # Create single EXE installer - bundles everything (JVM, JAR, dependencies)
        # --win-per-user-install installs to AppData, making it feel more portable
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --type exe `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --win-dir-chooser `
            --win-menu `
            --win-shortcut `
            --win-menu-group "KonvertR" `
            --win-per-user-install `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build EXE installer!"
          Write-Host "This might be due to WiX Toolset not being found."
          exit 1
        }
        
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        if (-not $exeFile) {
          Write-Host "ERROR: EXE installer was not created!"
          exit 1
        }
        
        Write-Host "✓ Single EXE installer created: $($exeFile.Name)"
        Write-Host "  Size: $([math]::Round($exeFile.Length / 1MB, 2)) MB"
        Write-Host "  This EXE bundles JVM, JAR, and all dependencies"
        Write-Host "  Users double-click to install and launch"
    
    - name: Verify executable
      run: |
        Write-Host "Verifying executable..."
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        if ($exeFile) {
          Write-Host "  Found: $($exeFile.Name) ($([math]::Round($exeFile.Length / 1MB, 2)) MB)"
          Write-Host "  ✓ Single EXE file - no JAR or source code visible"
        } else {
          Write-Host "ERROR: Executable not found!"
          exit 1
        }
        Write-Host "✓ Executable verified"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          # Remove 'v' prefix if present
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        # Find the EXE installer file
        $exeFile = Get-ChildItem "dist\KonvertR*.exe" | Select-Object -First 1
        if (-not $exeFile) {
          Write-Host "ERROR: EXE installer not found!"
          exit 1
        }
        
        # Create package directory
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        # Copy only the single EXE installer file
        Copy-Item $exeFile.FullName -Destination "$PACKAGE_NAME\$($exeFile.Name)" -Force
        Write-Host "  ✓ Copied single EXE installer: $($exeFile.Name)"
        
        # Copy documentation files
        $filesToCopy = @(
          @{src="README.md"; required=$false},
          @{src="QUICKSTART.md"; required=$false},
          @{src="LICENSE"; required=$false}
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file.src) {
            Copy-Item $file.src "$PACKAGE_NAME\" -ErrorAction SilentlyContinue
            if ($LASTEXITCODE -eq 0) {
              Write-Host "  ✓ Copied $($file.src)"
            }
          } elseif ($file.required) {
            Write-Host "  WARNING: $($file.src) not found (optional)"
          }
        }
        
        # Create README.txt for users
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Extract this ZIP file",
            "2. Double-click KonvertR.exe to install and launch",
            "3. The application will open in your default web browser",
            "",
            "Everything is bundled in the EXE file:",
            "  - Java Runtime (JVM)",
            "  - Application code",
            "  - All dependencies",
            "",
            "No JAR files or source code visible to end users!",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "INSTALLATION NOTES",
            "========================================",
            "",
            "The EXE installer will:",
            "  - Install to your user AppData folder (portable-style)",
            "  - Create a Start Menu shortcut",
            "  - Launch the application automatically after installation",
            "",
            "You can uninstall via Windows Settings > Apps",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        # Create ZIP archive
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/KonvertR*.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR.exe (single installer EXE)"
          Write-Host "  - Java Runtime (bundled inside EXE)"
          Write-Host "  - Application code (bundled inside EXE)"
          Write-Host "  - All dependencies (bundled inside EXE)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Single EXE file - everything bundled"
          Write-Host "  ✓ No JAR files visible to users"
          Write-Host "  ✓ No source code visible to users"
          Write-Host "  ✓ Double-click to install and launch"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR.exe"
          Write-Host "  3. Installer runs and launches application"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR.exe` to install and launch
          3. The application will open in your default web browser
          
          **Single EXE installer** - Everything bundled (JVM, code, dependencies)
          
          ### What's Included
          - ✅ Single EXE file - no JAR files or source code visible
          - ✅ Java Runtime bundled inside the EXE
          - ✅ All dependencies bundled inside the EXE
          - ✅ Portable installation to user AppData folder
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
