name: Build Windows Executables

on:
  workflow_dispatch:  # Manual trigger
  push:
    tags:
      - 'v*'  # Trigger on version tags
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build single EXE installer
      run: |
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        $jarName = $jarFile.Name
        
        Write-Host "Building single EXE installer..."
        Write-Host "JAR: $jarName"
        Write-Host "Version: $version"
        
        # Ensure WiX is in PATH
        $wixPaths = @(
          "C:\Program Files (x86)\WiX Toolset v3.11\bin",
          "C:\Program Files (x86)\WiX Toolset v3.14\bin",
          "$env:TEMP\wix"
        )
        
        foreach ($path in $wixPaths) {
          if (Test-Path "$path\candle.exe") {
            $env:PATH = "$path;$env:PATH"
            break
          }
        }
        
        # Create portable app-image - bundles everything (JVM, JAR, dependencies)
        # This creates a folder with KonvertR.exe that can be run directly
        # No installer needed - just double-click the EXE
        jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "ERROR: Failed to build portable executable!"
          exit 1
        }
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: Executable was not created!"
          exit 1
        }
        
        Write-Host "✓ Portable executable created: dist\KonvertR\KonvertR.exe"
        Write-Host "  JVM and all dependencies are bundled"
        Write-Host "  Users double-click KonvertR.exe to launch"
    
    - name: Verify executable structure
      run: |
        Write-Host "Verifying executable structure..."
        
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: KonvertR.exe not found!"
          exit 1
        }
        
        $exeInfo = Get-Item "dist\KonvertR\KonvertR.exe"
        Write-Host "  ✓ Found: KonvertR.exe ($([math]::Round($exeInfo.Length / 1MB, 2)) MB)"
        
        # Verify runtime folder exists (contains JVM)
        if (Test-Path "dist\KonvertR\runtime") {
          $runtimeSize = (Get-ChildItem "dist\KonvertR\runtime" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "  ✓ Found: runtime folder ($([math]::Round($runtimeSize, 2)) MB) - JVM bundled"
        } else {
          Write-Host "  WARNING: runtime folder not found - JVM may not be bundled!"
        }
        
        # Verify app folder exists (contains application)
        if (Test-Path "dist\KonvertR\app") {
          Write-Host "  ✓ Found: app folder - Application files bundled"
        } else {
          Write-Host "  WARNING: app folder not found!"
        }
        
        # List contents for debugging
        Write-Host ""
        Write-Host "Contents of dist\KonvertR:"
        Get-ChildItem "dist\KonvertR" | ForEach-Object {
          if ($_.PSIsContainer) {
            Write-Host "  [DIR]  $($_.Name)"
          } else {
            Write-Host "  [FILE] $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
          }
        }
        
        Write-Host ""
        Write-Host "✓ Executable structure verified"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          # Remove 'v' prefix if present
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        # Verify the app-image exists
        if (-not (Test-Path "dist\KonvertR\KonvertR.exe")) {
          Write-Host "ERROR: KonvertR executable not found!"
          exit 1
        }
        
        # Create package directory
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        # Copy the entire KonvertR app-image folder (contains EXE + runtime)
        # The runtime folder is required for the EXE to work, but users only need to click KonvertR.exe
        Copy-Item -Path "dist\KonvertR\*" -Destination "$PACKAGE_NAME\" -Recurse -Force
        Write-Host "  ✓ Copied KonvertR executable and runtime"
        
        # Copy documentation files
        $filesToCopy = @(
          @{src="README.md"; required=$false},
          @{src="QUICKSTART.md"; required=$false},
          @{src="LICENSE"; required=$false}
        )
        
        foreach ($file in $filesToCopy) {
          if (Test-Path $file.src) {
            Copy-Item $file.src "$PACKAGE_NAME\" -ErrorAction SilentlyContinue
            if ($LASTEXITCODE -eq 0) {
              Write-Host "  ✓ Copied $($file.src)"
            }
          } elseif ($file.required) {
            Write-Host "  WARNING: $($file.src) not found (optional)"
          }
        }
        
        # Create README.txt for users
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Extract this ZIP file to any location",
            "2. Double-click KonvertR.exe to launch",
            "3. The application will open in your default web browser",
            "",
            "No installation required! Just extract and run.",
            "",
            "Everything is bundled:",
            "  - Java Runtime (JVM) - in runtime folder",
            "  - Application code - bundled in app folder",
            "  - All dependencies - included",
            "",
            "You only need to click KonvertR.exe - everything else is automatic!",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If KonvertR.exe doesn't launch:",
            "1. Make sure you extracted ALL files from the ZIP",
            "2. Keep the runtime and app folders in the same directory as KonvertR.exe",
            "3. Try running as Administrator",
            "4. Check Windows Firewall settings",
            "5. Ensure port 8080 is not in use",
            "",
            "The runtime and app folders are required - do not delete them!",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        # Create ZIP archive
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/KonvertR/KonvertR.exe
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR.exe (main executable - double-click to run)"
          Write-Host "  - runtime/ (Java Runtime - required, bundled)"
          Write-Host "  - app/ (Application files - required, bundled)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Portable application - no installation needed"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ Double-click KonvertR.exe to launch"
          Write-Host "  ✓ All dependencies included"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file"
          Write-Host "  2. Double-click KonvertR.exe"
          Write-Host "  3. Application opens in browser automatically"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract the ZIP file
          2. Double-click `KonvertR.exe` to launch
          3. The application will open in your default web browser automatically
          
          **Portable application** - No installation required! Just extract and run.
          
          ### What's Included
          - ✅ KonvertR.exe - main executable (double-click to run)
          - ✅ Java Runtime bundled (in runtime folder)
          - ✅ All dependencies included (in app folder)
          - ✅ Everything bundled - no external dependencies needed
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
