name: Build Windows Portable Package

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        CI: false
        DISABLE_ESLINT_PLUGIN: true
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found!"
          exit 1
        }
        
        Write-Host "Found JAR: $($jarFile.Name)"
        $jarName = $jarFile.Name
    
    - name: Clean previous builds
      run: |
        if (Test-Path "dist") {
          Remove-Item -Recurse -Force "dist"
        }
        if (Test-Path "build") {
          Remove-Item -Recurse -Force "build"
        }
        Write-Host "✓ Cleanup complete"
    
    - name: Build portable package (no installer, runs directly)
      run: |
        $ErrorActionPreference = "Stop"
        $version = "1.0.0"
        if ($env:GITHUB_REF -like "refs/tags/v*") {
            $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        }
        
        Write-Host "========================================"
        Write-Host "Building Portable Package"
        Write-Host "========================================"
        Write-Host "Version: $version"
        
        # Verify JAR exists
        $jarFile = Get-ChildItem "target\konvertr-*.jar" | Where-Object { 
          $_.Name -notlike "*-sources.jar" -and 
          $_.Name -notlike "*-javadoc.jar" -and 
          $_.Name -notlike "*-original.jar" 
        } | Select-Object -First 1
        
        if ($null -eq $jarFile) {
          Write-Host "ERROR: JAR file not found in target directory!"
          Write-Host "Contents of target directory:"
          Get-ChildItem "target\" | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        $jarName = $jarFile.Name
        Write-Host "JAR: $jarName"
        Write-Host "JAR Size: $([math]::Round($jarFile.Length / 1MB, 2)) MB"
        Write-Host ""
        
        # Create portable app-image using jpackage
        # This creates a folder with KonvertR.exe that runs directly (no installation)
        Write-Host "Creating portable app-image with jpackage..."
        Write-Host "This creates KonvertR folder with KonvertR.exe (runs directly)"
        Write-Host ""
        
        $jpackageOutput = jpackage --input target `
            --name KonvertR `
            --main-jar $jarName `
            --main-class com.konvert.KonvertApplication `
            --type app-image `
            --app-version $version `
            --description "KonvertR - Universal Format Converter" `
            --vendor "KonvertR" `
            --copyright "Copyright 2024 KonvertR" `
            --dest dist `
            --java-options "-Xmx512m" `
            --java-options "-Dserver.port=8080" `
            --java-options "-Djava.awt.headless=false" `
            2>&1
        
        $jpackageExitCode = $LASTEXITCODE
        
        # Always show jpackage output for debugging
        Write-Host "jpackage output:"
        Write-Host $jpackageOutput
        
        if ($jpackageExitCode -ne 0) {
          Write-Host ""
          Write-Host "ERROR: jpackage failed with exit code $jpackageExitCode"
          Write-Host "Please check the output above for error messages."
          exit 1
        }
        
        # Verify KonvertR.exe was created
        $exePath = "dist\KonvertR\KonvertR.exe"
        if (-not (Test-Path $exePath)) {
          Write-Host ""
          Write-Host "ERROR: KonvertR.exe was not created!"
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist\" -Recurse | Select-Object -First 20 | ForEach-Object { Write-Host "  - $($_.FullName)" }
          } else {
            Write-Host "  dist directory does not exist!"
          }
          exit 1
        }
        
        Write-Host ""
        Write-Host "✓ Portable app-image created successfully!"
        Write-Host "  Executable: dist\KonvertR\KonvertR.exe"
        
        # Verify executable structure
        Write-Host ""
        Write-Host "Verifying package structure..."
        $exeFile = Get-Item $exePath
        Write-Host "  ✓ KonvertR.exe exists ($([math]::Round($exeFile.Length / 1MB, 2)) MB)"
        
        # Check for runtime
        $runtimePath = "dist\KonvertR\runtime"
        if (Test-Path $runtimePath) {
          $runtimeSize = (Get-ChildItem $runtimePath -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "  ✓ Java Runtime bundled ($([math]::Round($runtimeSize, 2)) MB)"
        } else {
          Write-Host "  ⚠ Warning: Runtime folder not found (may use system Java)"
        }
        
        # Check for app folder (contains JAR)
        $appPath = "dist\KonvertR\app"
        if (Test-Path $appPath) {
          Write-Host "  ✓ App folder exists (contains application files)"
          $jarCount = (Get-ChildItem $appPath -Filter "*.jar" -Recurse).Count
          Write-Host "    - Found $jarCount JAR file(s) in app folder"
        } else {
          Write-Host "  ⚠ Warning: App folder not found"
        }
        
        Write-Host ""
        Write-Host "Package structure verified!"
        Write-Host ""
        Write-Host "========================================"
        
        # Create ZIP package
        Write-Host ""
        Write-Host "Creating ZIP package..."
        $zipPath = "dist\KonvertR-Portable-$version.zip"
        if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
        
        Compress-Archive -Path "dist\KonvertR\*" -DestinationPath $zipPath -Force
        
        if (-not (Test-Path $zipPath)) {
          Write-Host "ERROR: Failed to create ZIP package!"
          exit 1
        }
        
        $zipSize = (Get-Item $zipPath).Length / 1MB
        Write-Host "✓ ZIP package created: $zipPath"
        Write-Host "  Size: $([math]::Round($zipSize, 2)) MB"
        Write-Host ""
        Write-Host "Usage:"
        Write-Host "  1. Extract ZIP file"
        Write-Host "  2. Open KonvertR folder"
        Write-Host "  3. Double-click KonvertR.exe to run"
        Write-Host "  4. No installation needed - runs directly!"
        Write-Host ""
        Write-Host "========================================"
    
    - name: Verify package and test launch
      run: |
        Write-Host "Verifying package..."
        
        $exePath = "dist\KonvertR\KonvertR.exe"
        if (-not (Test-Path $exePath)) {
          Write-Host "ERROR: KonvertR.exe not found!"
          Write-Host "Contents of dist directory:"
          if (Test-Path "dist") {
            Get-ChildItem "dist\" -Recurse | Select-Object -First 20 | ForEach-Object { Write-Host "  - $($_.FullName)" }
          }
          exit 1
        }
        
        $exeInfo = Get-Item $exePath
        $exeSize = $exeInfo.Length / 1MB
        
        Write-Host "  ✓ Found: KonvertR.exe"
        Write-Host "  ✓ Size: $([math]::Round($exeSize, 2)) MB"
        Write-Host "  ✓ Type: Portable App-Image (jpackage --type app-image)"
        Write-Host ""
        
        # Verify ZIP exists
        $zipFile = Get-ChildItem "dist\KonvertR-Portable-*.zip" | Select-Object -First 1
        if ($zipFile) {
          $zipSize = $zipFile.Length / 1MB
          Write-Host "  ✓ ZIP package: $($zipFile.Name)"
          Write-Host "  ✓ ZIP Size: $([math]::Round($zipSize, 2)) MB"
        }
        
        Write-Host ""
        Write-Host "✓ Package verified"
        Write-Host "  - Pure Java solution (jpackage only)"
        Write-Host "  - Portable folder with KonvertR.exe"
        Write-Host "  - No installation needed - runs directly"
        Write-Host "  - Java Runtime bundled"
        Write-Host "  - Users extract ZIP and run KonvertR.exe"
    
    - name: Get version from tag or default
      id: get_version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $VERSION = "${{ github.ref_name }}"
          $VERSION = $VERSION -replace '^v', ''
        } else {
          $VERSION = "1.0.0"
        }
        Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        Write-Host "Using version: $VERSION"
    
    - name: Create distribution package
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        if ([string]::IsNullOrEmpty($VERSION)) {
          $VERSION = "1.0.0"
        }
        $PACKAGE_NAME = "konvertr-tool-windows-v$VERSION"
        
        Write-Host "Creating distribution package: $PACKAGE_NAME"
        
        $zipFile = Get-ChildItem "dist\KonvertR-Portable-*.zip" | Select-Object -First 1
        
        if ($null -eq $zipFile -or -not (Test-Path $zipFile.FullName)) {
          Write-Host "ERROR: Portable ZIP package not found!"
          exit 1
        }
        
        New-Item -ItemType Directory -Force -Path $PACKAGE_NAME | Out-Null
        
        Copy-Item -Path $zipFile.FullName -Destination "$PACKAGE_NAME\$($zipFile.Name)" -Force
        Write-Host "  ✓ Copied portable ZIP: $($zipFile.Name)"
        
        $readmeLines = @(
            "KonvertR - Universal Format Converter",
            "Version: $VERSION",
            "",
            "========================================",
            "QUICK START",
            "========================================",
            "",
            "1. Extract the ZIP file to any location (e.g., Desktop, USB drive)",
            "2. Open the extracted KonvertR folder",
            "3. Double-click KonvertR.exe to run",
            "4. No installation required - runs directly!",
            "",
            "Everything is bundled in the KonvertR folder:",
            "  - Java Runtime (JVM) - included in the package",
            "  - Application code - included in the package",
            "  - All dependencies - included",
            "",
            "The KonvertR folder contains everything needed - just extract and run.",
            "JAR files are in the app/ subfolder but users just need to run KonvertR.exe.",
            "",
            "========================================",
            "SYSTEM REQUIREMENTS",
            "========================================",
            "",
            "- Windows 10 or later",
            "- 200 MB free disk space",
            "- No additional software needed (Java is bundled)",
            "",
            "========================================",
            "FEATURES",
            "========================================",
            "",
            "- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats",
            "- Format and beautify data",
            "- Encode/Decode utilities (Base64, URL, HTML, Hex)",
            "- JWT decoder",
            "- File upload and processing",
            "- All features work offline",
            "",
            "========================================",
            "TROUBLESHOOTING",
            "========================================",
            "",
            "If KonvertR.exe doesn't run:",
            "1. Make sure you extracted the entire KonvertR folder (not just the EXE)",
            "2. Try running as Administrator",
            "3. Check Windows Firewall settings",
            "4. Ensure port 8080 is not in use",
            "5. Check Windows Defender/antivirus settings",
            "6. Make sure all files in the KonvertR folder are present",
            "",
            "========================================"
        )
        $readmeLines | Out-File -FilePath "$PACKAGE_NAME\README.txt" -Encoding UTF8
        Write-Host "  ✓ Created README.txt"
        
        Write-Host "Creating ZIP archive..."
        Compress-Archive -Path "$PACKAGE_NAME\*" -DestinationPath "$PACKAGE_NAME.zip" -Force
        
        if (-not (Test-Path "$PACKAGE_NAME.zip")) {
          Write-Host "ERROR: ZIP file was not created!"
          exit 1
        }
        
        $zipSize = (Get-Item "$PACKAGE_NAME.zip").Length / 1MB
        Write-Host "✓ Created: $PACKAGE_NAME.zip ($([math]::Round($zipSize, 2)) MB)"
        Write-Host "  Package contains the portable ZIP and README"
        Write-Host "  Users extract ZIP and run KonvertR.exe directly!"
    
    - name: Upload Windows portable package
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-package
        path: dist/KonvertR-Portable-*.zip
        retention-days: 30
    
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: windows-distribution-package
        path: konvertr-tool-windows-v*.zip
        retention-days: 30
    
    - name: Display package contents
      run: |
        $zipFile = Get-ChildItem -Path "." -Filter "konvertr-tool-windows-v*.zip" | Select-Object -First 1
        if ($zipFile) {
          Write-Host "========================================"
          Write-Host "Distribution Package Created"
          Write-Host "========================================"
          Write-Host "File: $($zipFile.Name)"
          Write-Host "Size: $([math]::Round($zipFile.Length / 1MB, 2)) MB"
          Write-Host ""
          Write-Host "Package includes:"
          Write-Host "  - KonvertR-Portable-*.zip (Portable ZIP package)"
          Write-Host "  - README.txt (user guide)"
          Write-Host ""
          Write-Host "Features:"
          Write-Host "  ✓ Portable ZIP package - extract and run"
          Write-Host "  ✓ KonvertR.exe runs directly - no installation"
          Write-Host "  ✓ Java Runtime bundled - no JRE needed"
          Write-Host "  ✓ All dependencies included"
          Write-Host "  ✓ Simple and reliable - uses only jpackage (pure Java)"
          Write-Host ""
          Write-Host "Usage:"
          Write-Host "  1. Extract ZIP file to any location"
          Write-Host "  2. Open the KonvertR folder"
          Write-Host "  3. Double-click KonvertR.exe"
          Write-Host "  4. No installation needed - runs directly!"
          Write-Host "========================================"
        }
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: konvertr-tool-windows-v*.zip
        body: |
          ## KonvertR Windows Distribution
          
          ### Quick Start
          1. Download and extract `KonvertR-Portable-*.zip`
          2. Open the `KonvertR` folder
          3. Double-click `KonvertR.exe` to run
          4. No installation required - runs directly!
          
          **Portable Package** - Simple, reliable, and easy to use!
          
          ### What's Included
          - ✅ KonvertR-Portable-*.zip - Portable ZIP package
          - ✅ KonvertR folder with KonvertR.exe (ready to run)
          - ✅ Java Runtime bundled (included in package)
          - ✅ All dependencies included (included in package)
          - ✅ Pure Java solution - uses only jpackage (no external tools)
          - ✅ No installation needed - extract and run!
          
          ### System Requirements
          - Windows 10 or later
          - 200 MB free disk space
          - No additional software needed (Java is bundled)
          
          ### Features
          - Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
          - Format and beautify data
          - Encode/Decode utilities
          - File upload and processing
          - All features work offline
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
