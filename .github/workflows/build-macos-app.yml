name: Build macOS App Distribution

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build-macos-app:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        architecture: x64
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
    
    - name: Deploy frontend to static resources
      working-directory: ./frontend
      run: node deploy.js
    
    - name: Build Spring Boot application
      run: mvn clean package -DskipTests
    
    - name: Verify JAR exists
      run: |
        JAR_FILE=$(ls target/konvertr-*.jar 2>/dev/null | grep -v sources | grep -v javadoc | grep -v original | head -1)
        if [ -z "$JAR_FILE" ]; then
          echo "ERROR: JAR file not found!"
          exit 1
        fi
        echo "Found JAR: $JAR_FILE"
        JAR_NAME=$(basename "$JAR_FILE")
        echo "JAR_NAME=$JAR_NAME" >> $GITHUB_ENV
    
    - name: Create macOS DMG installer
      run: |
        VERSION="1.0.0"
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        echo "Creating macOS DMG installer..."
        echo "JAR: $JAR_NAME"
        echo "Version: $VERSION"
        
        jpackage --input target \
            --name KonvertR \
            --main-jar "$JAR_NAME" \
            --type dmg \
            --app-version "$VERSION" \
            --description "KonvertR - Universal Format Converter" \
            --vendor "KonvertR" \
            --copyright "Copyright 2024 KonvertR" \
            --dest dist \
            --java-options "-Xmx512m" \
            --java-options "-Dserver.port=8080"
        
        if [ $? -ne 0 ]; then
          echo "ERROR: jpackage failed!"
          exit 1
        fi
    
    - name: Verify DMG created
      run: |
        DMG_FILE=$(ls dist/KonvertR*.dmg 2>/dev/null | head -1)
        if [ -z "$DMG_FILE" ]; then
          echo "ERROR: DMG file not found!"
          exit 1
        fi
        echo "DMG created: $DMG_FILE"
        ls -lh "$DMG_FILE" | awk '{print "Size: " $5}'
    
    - name: Create distribution package
      run: |
        VERSION="1.0.0"
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        DMG_FILE=$(ls dist/KonvertR*.dmg 2>/dev/null | head -1)
        DMG_NAME=$(basename "$DMG_FILE")
        
        # Create distribution directory
        mkdir -p "dist/KonvertR-macOS-$VERSION"
        
        # Copy only the DMG file
        cp "$DMG_FILE" "dist/KonvertR-macOS-$VERSION/$DMG_NAME"
        
        # Create README
        cat > "dist/KonvertR-macOS-$VERSION/README.txt" << 'HEREDOC_EOF'
# KonvertR - Universal Format Converter

## Installation

1. Open KonvertR-VERSION_PLACEHOLDER.dmg
2. Drag KonvertR.app to Applications folder
3. Launch from Applications or Launchpad

## System Requirements

- macOS 10.13 (High Sierra) or later
- 200 MB free disk space

## Features

- Convert between JSON, YAML, TOML, XML, CSV, Protobuf, Properties formats
- Format and beautify data
- Encode/Decode utilities
- File upload and processing
- All features work offline

## First Run

On first launch, you may see a security warning:
1. Right-click KonvertR.app and select "Open"
2. Or go to System Preferences > Security & Privacy > General
3. Click "Open Anyway"

Version: VERSION_PLACEHOLDER
HEREDOC_EOF
        
        # Replace version placeholder
        sed -i '' "s/VERSION_PLACEHOLDER/$VERSION/g" "dist/KonvertR-macOS-$VERSION/README.txt"
    
    - name: Create ZIP distribution
      run: |
        VERSION="1.0.0"
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        ZIP_NAME="KonvertR-macOS-$VERSION.zip"
        cd dist
        zip -r "$ZIP_NAME" "KonvertR-macOS-$VERSION/" > /dev/null
        echo "Created: $ZIP_NAME"
        ls -lh "$ZIP_NAME" | awk '{print "Size: " $5}'
        cd ..
    
    - name: Upload macOS App distribution
      uses: actions/upload-artifact@v4
      with:
        name: KonvertR-macOS-App
        path: dist/KonvertR-macOS-*.zip
        retention-days: 30
    
    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/KonvertR-macOS-*.zip
        body: |
          ## KonvertR macOS App Distribution
          
          ### Installation
          1. Download and extract the ZIP file
          2. Open `KonvertR-{version}.dmg`
          3. Drag KonvertR.app to Applications
          
          ### System Requirements
          - macOS 10.13 or later
          - 200 MB free disk space
          
          **Note:** On first run, you may need to right-click and select "Open" to bypass Gatekeeper.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
